(() => {
  const translations = {
    en: {
      appTitle: 'EduMelody',
      tempoLabel: 'Tempo',
      bpmLabel: 'BPM',
      play: 'Play',
      pause: 'Pause',
      clear: 'Clear',
      randomize: 'Randomize',
      download: 'Download WAV',
      exporting: 'Exporting WAV',
      controlsShow: 'Show controls',
      controlsHide: 'Hide controls',
      tonic: 'Tonic',
      scale: 'Scale',
      notes: 'Notes',
      pulses: 'Pulses',
      instrument: 'Instrument',
      language: 'Language',
      major: 'Major',
      minor: 'Minor',
      pentatonic: 'Pentatonic',
      pentatonicMajor: 'Pentatonic (Major)',
      pentatonicMinor: 'Pentatonic (Minor)',
      lydian: 'Lydian',
      mixolydian: 'Mixolydian',
      dorian: 'Dorian',
      phrygian: 'Phrygian',
      locrian: 'Locrian',
      piano: 'Piano',
      electricPiano: 'Electric Piano',
      nylonGuitar: 'Nylon Guitar',
      violin: 'Violin',
      synthLead: 'Synth Lead',
      viola: 'Viola',
      cello: 'Cello',
      contrabass: 'Contrabass',
      stringEnsemble: 'String Ensemble',
      stringEnsemble2: 'String Ensemble 2',
      flute: 'Flute',
      piccolo: 'Piccolo',
      oboe: 'Oboe',
      englishHorn: 'English Horn',
      clarinet: 'Clarinet',
      bassoon: 'Bassoon',
      trumpet: 'Trumpet',
      frenchHorn: 'French Horn',
      trombone: 'Trombone',
      tuba: 'Tuba',
      timpani: 'Timpani',
      articulation: 'Articulation',
      articulationSustain: 'Sustain',
      articulationDiscrete: 'Discrete',
      sine: 'Sine',
      triangle: 'Triangle',
      square: 'Square',
      sawtooth: 'Sawtooth',
      helpTitle: 'Help',
      helpClose: 'Close',
      installApp: 'Install app',
      helpIntro: 'Create melodies by clicking the grid.',
      helpStep1: 'Click a cell to activate a note.',
      helpStep2: 'Click again to extend the note (up to 4 steps). The color changes with duration.',
      helpStep3: 'After the longest duration, the next click clears the note.',
      helpStep4: 'Use Play to start/stop and adjust tempo, key, and scale.',
      helpStep5: 'Switch instruments anytime; SoundFonts load online.',
      helpStep6: 'Export your loop to WAV when ready.',
      helpShortcutsTitle: 'Shortcuts',
      helpShortcutSpace: 'Play/Pause'
    },
    es: {
      appTitle: 'EduMelody',
      tempoLabel: 'Tempo',
      bpmLabel: 'BPM',
      play: 'Reproducir',
      pause: 'Pausar',
      clear: 'Limpiar',
      randomize: 'Aleatorizar',
      download: 'Descargar WAV',
      exporting: 'Exportando WAV',
      controlsShow: 'Mostrar controles',
      controlsHide: 'Ocultar controles',
      tonic: 'Tónica',
      scale: 'Escala',
      notes: 'Notas',
      pulses: 'Pulsos',
      instrument: 'Instrumento',
      language: 'Idioma',
      major: 'Mayor',
      minor: 'Menor',
      pentatonic: 'Pentatónica',
      pentatonicMajor: 'Pentatónica (mayor)',
      pentatonicMinor: 'Pentatónica (menor)',
      lydian: 'Lidio',
      mixolydian: 'Mixolidio',
      dorian: 'Dórico',
      phrygian: 'Frigio',
      locrian: 'Locrio',
      piano: 'Piano',
      electricPiano: 'Piano eléctrico',
      nylonGuitar: 'Guitarra de nylon',
      violin: 'Violín',
      synthLead: 'Lead sintético',
      viola: 'Viola',
      cello: 'Violonchelo',
      contrabass: 'Contrabajo',
      stringEnsemble: 'Cuerda (ensemble)',
      stringEnsemble2: 'Cuerda (ensemble 2)',
      flute: 'Flauta',
      piccolo: 'Flautín',
      oboe: 'Oboe',
      englishHorn: 'Corno inglés',
      clarinet: 'Clarinete',
      bassoon: 'Fagot',
      trumpet: 'Trompeta',
      frenchHorn: 'Trompa',
      trombone: 'Trombón',
      tuba: 'Tuba',
      timpani: 'Timbales',
      articulation: 'Articulacion',
      articulationSustain: 'Sostener',
      articulationDiscrete: 'Separado',
      sine: 'Seno',
      triangle: 'Triángulo',
      square: 'Cuadrada',
      sawtooth: 'Diente de sierra',
      helpTitle: 'Ayuda',
      helpClose: 'Cerrar',
      installApp: 'Instalar app',
      helpIntro: 'Crea melodías haciendo clic en la cuadrícula.',
      helpStep1: 'Haz clic en una celda para activar una nota.',
      helpStep2: 'Haz clic de nuevo para alargarla (hasta 4 pulsos). El color cambia según la duración.',
      helpStep3: 'Después de la duración máxima, el siguiente clic borra la nota.',
      helpStep4: 'Usa Play para reproducir/pausar y ajusta tempo, tonalidad y escala.',
      helpStep5: 'Cambia de instrumento cuando quieras; los SoundFonts se cargan online.',
      helpStep6: 'Exporta tu patrón a WAV cuando esté listo.',
      helpShortcutsTitle: 'Atajos',
      helpShortcutSpace: 'Reproducir/Pausar'
    },
    ca: {
      appTitle: 'EduMelody',
      tempoLabel: 'Tempo',
      bpmLabel: 'BPM',
      play: 'Reproduir',
      pause: 'Pausar',
      clear: 'Netejar',
      randomize: 'Aleatoritzar',
      download: 'Descarregar WAV',
      exporting: 'Exportant WAV',
      controlsShow: 'Mostrar controls',
      controlsHide: 'Amagar controls',
      tonic: 'Tònica',
      scale: 'Escala',
      notes: 'Notes',
      pulses: 'Polsos',
      instrument: 'Instrument',
      language: 'Llengua',
      major: 'Major',
      minor: 'Menor',
      pentatonic: 'Pentatònica',
      pentatonicMajor: 'Pentatònica (major)',
      pentatonicMinor: 'Pentatònica (menor)',
      lydian: 'Lidi',
      mixolydian: 'Mixolidi',
      dorian: 'Dori',
      phrygian: 'Frigi',
      locrian: 'Locrí',
      piano: 'Piano',
      electricPiano: 'Piano elèctric',
      nylonGuitar: 'Guitarra de niló',
      violin: 'Violí',
      synthLead: 'Lead sintètic',
      viola: 'Viola',
      cello: 'Violoncel',
      contrabass: 'Contrabaix',
      stringEnsemble: 'Corda (ensemble)',
      stringEnsemble2: 'Corda (ensemble 2)',
      flute: 'Flauta',
      piccolo: 'Flautí',
      oboe: 'Oboè',
      englishHorn: 'Corn anglès',
      clarinet: 'Clarinet',
      bassoon: 'Fagot',
      trumpet: 'Trompeta',
      frenchHorn: 'Trompa',
      trombone: 'Trombó',
      tuba: 'Tuba',
      timpani: 'Timbales',
      articulation: 'Articulacio',
      articulationSustain: 'Sostingut',
      articulationDiscrete: 'Separat',
      sine: 'Sinusoidal',
      triangle: 'Triangular',
      square: 'Quadrada',
      sawtooth: 'Dent de serra',
      helpTitle: 'Ajuda',
      helpClose: 'Tancar',
      installApp: 'Instal·lar app',
      helpIntro: 'Crea melodies fent clic a la graella.',
      helpStep1: 'Fes clic en una cel·la per activar una nota.',
      helpStep2: 'Fes clic de nou per allargar-la (fins a 4 polsos). El color canvia segons la durada.',
      helpStep3: 'Després de la durada màxima, el següent clic esborra la nota.',
      helpStep4: 'Fes servir Play per reproduir/pausar i ajusta tempo, tonalitat i escala.',
      helpStep5: 'Canvia d’instrument quan vulguis; els SoundFonts es carreguen en línia.',
      helpStep6: 'Exporta el patró a WAV quan estigui llest.',
      helpShortcutsTitle: 'Dreceres',
      helpShortcutSpace: 'Reproduir/Pausar'
    }
  };

  const state = {
    lang: 'en',
    strings: translations.en
  };

  const STORAGE_KEY = 'edumelody.language';

  function normalizeLanguage(lang) {
    if (!lang) return 'en';
    const lower = lang.toLowerCase();
    if (lower.startsWith('es')) return 'es';
    if (lower.startsWith('ca')) return 'ca';
    return 'en';
  }

  function getDefaultLanguage() {
    const navLang = (navigator.languages && navigator.languages.length)
      ? navigator.languages[0]
      : navigator.language;
    return normalizeLanguage(navLang);
  }

  function getSavedLanguage() {
    try {
      return normalizeLanguage(localStorage.getItem(STORAGE_KEY));
    } catch (error) {
      return 'en';
    }
  }

  function saveLanguage(lang) {
    try {
      localStorage.setItem(STORAGE_KEY, normalizeLanguage(lang));
    } catch (error) {
      return;
    }
  }

  function applyTranslations(lang) {
    state.lang = normalizeLanguage(lang);
    state.strings = translations[state.lang] || translations.en;
    document.documentElement.lang = state.lang;

    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const text = state.strings[key];
      if (text) {
        el.textContent = text;
      }
    });

    document.querySelectorAll('[data-i18n-title]').forEach(el => {
      const key = el.getAttribute('data-i18n-title');
      const text = state.strings[key];
      if (text) {
        el.setAttribute('title', text);
      }
    });

    document.querySelectorAll('[data-i18n-aria]').forEach(el => {
      const key = el.getAttribute('data-i18n-aria');
      const text = state.strings[key];
      if (text) {
        el.setAttribute('aria-label', text);
      }
    });
  }

  function setLanguage(lang) {
    applyTranslations(lang);
    return state;
  }

  function t(key) {
    return state.strings[key] || translations.en[key] || key;
  }

  window.i18n = {
    translations,
    state,
    getDefaultLanguage,
    getSavedLanguage,
    saveLanguage,
    setLanguage,
    t
  };
})();
